# Heron CMS

Heron is a modern, lightweight, and containerized CMS built for personal portfolios and blogs. It features a Next.js frontend, a SQLite database managed via Drizzle ORM, and integrated media management using S3-compatible storage.

## ðŸš€ Key Features

- **Content Management**: Full support for creating, editing, and deleting blog posts and photo albums.
- **Media Library**: Integrated image management with direct S3/MinIO uploads, automatic metadata tracking (dimensions, captions), and public URL generation.
- **Admin Dashboard**: A secure management interface (`/admin`) for site statistics and content control.
- **Authentication**: Powered by NextAuth.js, supporting Google OAuth for production and a local bypass for development.
- **Portable Data**: Uses SQLite for the main database, making the entire application easy to back up and move.
- **Infrastructure as Code**: Includes AWS CloudFormation templates for one-click deployment to AWS Lightsail.
- **Dockerized Workflow**: Seamless development and production environments using Docker and Docker Compose.

## ðŸ“Š Project Architecture

```mermaid
graph TD
    User((User)) --> NextJS[Next.js App]
    
    subgraph "Data & Storage"
        NextJS --> SQLite[(SQLite DB)]
        NextJS --> S3[S3 Media Storage]
    end
    
    subgraph Hosting
        NextJS --> Docker[Docker]
        Docker --> Lightsail[AWS Lightsail]
    end
```

## ðŸ“‚ Project Layout

```text
/
â”œâ”€â”€ heron/                  # Main Next.js application
â”‚   â”œâ”€â”€ app/                # App Router: Pages, Layouts, and API Routes
â”‚   â”‚   â”œâ”€â”€ admin/          # Management dashboard and tools
â”‚   â”‚   â”œâ”€â”€ api/            # Backend API endpoints (REST)
â”‚   â”‚   â””â”€â”€ (public)/       # Public pages (Posts, Albums, Resume)
â”‚   â”œâ”€â”€ components/         # Reusable React components
â”‚   â”œâ”€â”€ actions/            # UI/business actions (multi-step operations)
â”‚   â”œâ”€â”€ drizzle/            # SQL migration files generated by Drizzle
â”‚   â”œâ”€â”€ lib/                # Library setup (ORM, auth, storage, helpers)
â”‚   â”œâ”€â”€ services/           # Data access layer (DB queries)
â”‚   â”œâ”€â”€ scripts/            # Database seeding and maintenance scripts
â”‚   â””â”€â”€ public/             # Static assets (Robots.txt, icons)
â”œâ”€â”€ infra/                  # AWS CloudFormation templates for Lightsail
â”œâ”€â”€ .github/                # CI/CD Workflows (Deployments)
â”œâ”€â”€ .cursor/                # Project-specific AI rules and instructions
â”œâ”€â”€ docker-compose.yml      # Production orchestration (App + Volumes)
â””â”€â”€ docker-compose.dev.yml  # Local development (App + MinIO for local S3)
```

## ðŸ›  Technology Stack

- **Framework**: [Next.js 16](https://nextjs.org/) (App Router)
- **Runtime**: Node.js 22+
- **Language**: [TypeScript](https://www.typescriptlang.org/)
- **Database**: [SQLite](https://sqlite.org/) via [better-sqlite3](https://github.com/WiseLibs/better-sqlite3)
- **ORM**: [Drizzle ORM](https://orm.drizzle.team/)
- **Auth**: [NextAuth.js](https://next-auth.js.org/)
- **Storage**: S3-compatible ([AWS S3](https://aws.amazon.com/s3/) / [MinIO](https://min.io/))
- **Deployment**: [Docker](https://www.docker.com/) & [AWS Lightsail](https://aws.amazon.com/lightsail/)

## ðŸ’» Getting Started

### Local Development (recommended: Docker + MinIO)

1. **Environment**: Copy `heron/.env.local.example` to `heron/.env.local` and adjust values if needed.
2. **Start services (app + MinIO)**:
   ```bash
   docker compose -f docker-compose.dev.yml up --build
   ```
3. **Seed data**:
   ```bash
   docker compose exec heron npm run seed:local
   ```
4. **Access**:
   - Web App: `http://localhost:3000`
   - MinIO Console: `http://localhost:9001` (login with `minioadmin`/`minioadmin`)

### Local Development (no Docker)

1. **Node**: Use Node.js 22 (via `nvm use 22`).
2. **Install deps**:
   ```bash
   cd heron && npm install
   ```
3. **Run MinIO** (containerized):
   ```bash
   docker compose -f docker-compose.dev.yml up minio minio-init
   ```
4. **Initialize DB**:
   ```bash
   cd heron
   npm rebuild better-sqlite3
   npx tsx -e "import { getDb } from './lib/db/index.ts'; getDb(); console.log('db ready');"
   npm run seed:local
   ```
5. **Start dev server**:
   ```bash
   npm run dev
   ```

## ðŸš¢ Deployment

Deployments are automated via GitHub Actions to AWS Lightsail. The pipeline builds the Next.js app as a standalone output, rsyncs artifacts to the instance, and runs the app with pm2. The database lives in `/var/lib/heron-cms/data` on the server so it is not overwritten on deploy.

- **Workflow**: `.github/workflows/deploy-lightsail.yml`
- **Infrastructure**: `infra/lightsail-cms.yaml` (Lightsail instance, S3, CloudFront)
- **Local dev** uses Docker Compose and MinIO only; production does not run the app in Docker.

### HTTPS with Let's Encrypt

If the repo secrets **`ROUTE53_RECORD_NAME`** (your domain) and **`LETSENCRYPT_EMAIL`** (e.g. `admin@yourdomain.com`) are set, each deploy will attempt to obtain or renew a Let's Encrypt certificate and configure Apache to use it. Certbot runs on the instance and a cron job renews the cert twice daily. Ensure your domainâ€™s DNS already points to the Lightsail static IP before the first deploy so ACME validation can succeed.
