AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Photo management backend with Lambda, DynamoDB, and S3

Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues: [dev, staging, prod]
    Description: Environment name
  
  EnableLogging:
    Type: String
    Default: 'true'
    AllowedValues: ['true', 'false']
    Description: Enable CloudWatch logging
  
  EnableXRay:
    Type: String
    Default: 'false'
    AllowedValues: ['true', 'false']
    Description: Enable X-Ray tracing
  
  CorsOrigin:
    Type: String
    Default: '*'
    Description: CORS allowed origin
  
  ImageMaxSize:
    Type: Number
    Default: 10485760
    Description: Maximum image size in bytes (10MB)
  
  ThumbnailSize:
    Type: Number
    Default: 200
    Description: Thumbnail size in pixels
  
  MediumSize:
    Type: Number
    Default: 800
    Description: Medium image max size in pixels
  
  LambdaMemorySize:
    Type: Number
    Default: 512
    AllowedValues: [128, 256, 512, 1024, 2048, 3008]
    Description: Lambda memory size in MB
  
  LambdaTimeout:
    Type: Number
    Default: 30
    MinValue: 1
    MaxValue: 900
    Description: Lambda timeout in seconds
  
  EnableEncryption:
    Type: String
    Default: 'false'
    AllowedValues: ['true', 'false']
    Description: Enable encryption at rest
  
  EnableVersioning:
    Type: String
    Default: 'true'
    AllowedValues: ['true', 'false']
    Description: Enable S3 versioning
  
  NotificationEmail:
    Type: String
    Default: ''
    Description: Email for notifications (optional)
  
  GoogleOAuthClientId:
    Type: String
    NoEcho: true
    Description: Google OAuth 2.0 Client ID
  
  GoogleOAuthClientSecret:
    Type: String
    NoEcho: true
    Description: Google OAuth 2.0 Client Secret
  
  GoogleOAuthRedirectURL:
    Type: String
    Description: Google OAuth 2.0 Redirect URL (e.g., https://your-api.com/auth/callback)
  
  AuthorizedUserEmail:
    Type: String
    Default: 'lanctotsm@gmail.com'
    Description: Email address of the authorized user
  
  SessionTimeoutHours:
    Type: Number
    Default: 24
    MinValue: 1
    MaxValue: 168
    Description: Session timeout in hours (default 24 hours)

Conditions:
  IsProduction: !Equals [!Ref Environment, 'prod']
  EnableLoggingCondition: !Equals [!Ref EnableLogging, 'true']
  EnableEncryptionCondition: !Equals [!Ref EnableEncryption, 'true']
  EnableXRayCondition: !Equals [!Ref EnableXRay, 'true']
  EnableVersioningCondition: !Equals [!Ref EnableVersioning, 'true']
  HasNotificationEmail: !Not [!Equals [!Ref NotificationEmail, '']]

Globals:
  Function:
    Timeout: !Ref LambdaTimeout
    MemorySize: !Ref LambdaMemorySize
    Runtime: provided.al2
    Tracing: !If [EnableXRayCondition, Active, PassThrough]
    Environment:
      Variables:
        S3_BUCKET: !Ref PhotoBucket
        DYNAMODB_TABLE: !Ref PhotoMetadataTable
        SESSIONS_TABLE: !Ref SessionsTable
        ALBUMS_TABLE: !Ref AlbumsTable
        ENVIRONMENT: !Ref Environment
        IMAGE_MAX_SIZE: !Ref ImageMaxSize
        THUMBNAIL_SIZE: !Ref ThumbnailSize
        MEDIUM_SIZE: !Ref MediumSize
        GOOGLE_OAUTH_CLIENT_ID: !Ref GoogleOAuthClientId
        GOOGLE_OAUTH_CLIENT_SECRET: !Ref GoogleOAuthClientSecret
        GOOGLE_OAUTH_REDIRECT_URL: !Ref GoogleOAuthRedirectURL
        AUTHORIZED_USER_EMAIL: !Ref AuthorizedUserEmail
        SESSION_TIMEOUT_HOURS: !Ref SessionTimeoutHours

Resources:
  # KMS Key for encryption (if enabled)
  PhotoKMSKey:
    Type: AWS::KMS::Key
    Condition: EnableEncryptionCondition
    Properties:
      Description: !Sub "KMS Key for ${AWS::StackName} photo encryption"
      KeyPolicy:
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action: "kms:*"
            Resource: "*"
          - Sid: Allow Lambda Function via IAM
            Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action:
              - kms:Decrypt
              - kms:GenerateDataKey
            Resource: "*"
            Condition:
              StringEquals:
                kms:ViaService: !Sub "lambda.${AWS::Region}.amazonaws.com"

  PhotoKMSKeyAlias:
    Type: AWS::KMS::Alias
    Condition: EnableEncryptionCondition
    Properties:
      AliasName: !Sub "alias/${AWS::StackName}-photos-${Environment}"
      TargetKeyId: !Ref PhotoKMSKey

  # S3 Bucket for storing access logs
  S3AccessLogBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${AWS::StackName}-logs-${Environment}-${AWS::AccountId}"
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerPreferred
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldLogs
            Status: Enabled
            ExpirationInDays: !If [IsProduction, 90, 30]
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  # S3 Bucket Policy for log bucket to allow S3 log delivery
  S3AccessLogBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref S3AccessLogBucket
      PolicyDocument:
        Statement:
          - Sid: S3ServerAccessLogsPolicy
            Effect: Allow
            Principal:
              Service: logging.s3.amazonaws.com
            Action:
              - s3:PutObject
            Resource: !Join ["", [!GetAtt S3AccessLogBucket.Arn, "/photo-bucket-logs/*"]]
            Condition:
              StringEquals:
                aws:SourceAccount: !Ref AWS::AccountId
              ArnLike:
                aws:SourceArn: !GetAtt PhotoBucket.Arn

  # S3 Bucket for photo storage
  PhotoBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${AWS::StackName}-photos-${Environment}-${AWS::AccountId}"
      VersioningConfiguration:
        Status: !If [EnableVersioningCondition, Enabled, Suspended]
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: !If [EnableEncryptionCondition, aws:kms, AES256]
              KMSMasterKeyID: !If [EnableEncryptionCondition, !Ref PhotoKMSKey, !Ref AWS::NoValue]
            BucketKeyEnabled: !If [EnableEncryptionCondition, true, false]
      PublicAccessBlockConfiguration:
        BlockPublicAcls: false
        BlockPublicPolicy: false
        IgnorePublicAcls: false
        RestrictPublicBuckets: false
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders: ["*"]
            AllowedMethods: [GET, PUT, POST, DELETE, HEAD]
            AllowedOrigins: [!Ref CorsOrigin]
            MaxAge: 3000
      LifecycleConfiguration:
        Rules:
          - Id: DeleteIncompleteMultipartUploads
            Status: Enabled
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 7
          - Id: TransitionToIA
            Status: Enabled
            Transitions:
              - TransitionInDays: 30
                StorageClass: STANDARD_IA
              - TransitionInDays: 90
                StorageClass: GLACIER
      LoggingConfiguration:
        DestinationBucketName: !Ref S3AccessLogBucket
        LogFilePrefix: photo-bucket-logs/

  # S3 Bucket Policy for public read access to photos
  PhotoBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref PhotoBucket
      PolicyDocument:
        Statement:
          - Sid: PublicReadGetObject
            Effect: Allow
            Principal: "*"
            Action: s3:GetObject
            Resource: !Join ["", [!GetAtt PhotoBucket.Arn, "/photos/*"]]
          - Sid: DenyInsecureConnections
            Effect: Deny
            Principal: "*"
            Action: s3:*
            Resource:
              - !Join ["", [!GetAtt PhotoBucket.Arn, "/*"]]
              - !GetAtt PhotoBucket.Arn
            Condition:
              Bool:
                "aws:SecureTransport": "false"

  # DynamoDB table for photo metadata
  PhotoMetadataTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${AWS::StackName}-photo-metadata-${Environment}"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
        - AttributeName: uploadedAt
          AttributeType: S
        - AttributeName: album_id
          AttributeType: S
        - AttributeName: user_email
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: UploadedAtIndex
          KeySchema:
            - AttributeName: uploadedAt
              KeyType: HASH
          Projection:
            ProjectionType: ALL
        - IndexName: album_id-uploaded_at-index
          KeySchema:
            - AttributeName: album_id
              KeyType: HASH
            - AttributeName: uploadedAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: user_email-uploaded_at-index
          KeySchema:
            - AttributeName: user_email
              KeyType: HASH
            - AttributeName: uploadedAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: !If [IsProduction, true, false]
      SSESpecification:
        SSEEnabled: !If [EnableEncryptionCondition, true, false]
        SSEType: !If [EnableEncryptionCondition, KMS, AES256]
        KMSMasterKeyId: !If [EnableEncryptionCondition, !Ref PhotoKMSKey, !Ref AWS::NoValue]
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: PhotoBackend

  # DynamoDB table for user sessions
  SessionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${AWS::StackName}-sessions-${Environment}"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: session_token
          AttributeType: S
        - AttributeName: user_email
          AttributeType: S
        - AttributeName: created_at
          AttributeType: S
      KeySchema:
        - AttributeName: session_token
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: user_email-created_at-index
          KeySchema:
            - AttributeName: user_email
              KeyType: HASH
            - AttributeName: created_at
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: expires_at
        Enabled: true
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: !If [IsProduction, true, false]
      SSESpecification:
        SSEEnabled: !If [EnableEncryptionCondition, true, false]
        SSEType: !If [EnableEncryptionCondition, KMS, AES256]
        KMSMasterKeyId: !If [EnableEncryptionCondition, !Ref PhotoKMSKey, !Ref AWS::NoValue]
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: PhotoBackend

  # DynamoDB table for albums
  AlbumsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${AWS::StackName}-albums-${Environment}"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: album_id
          AttributeType: S
        - AttributeName: user_email
          AttributeType: S
        - AttributeName: created_at
          AttributeType: S
      KeySchema:
        - AttributeName: album_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: user_email-created_at-index
          KeySchema:
            - AttributeName: user_email
              KeyType: HASH
            - AttributeName: created_at
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: !If [IsProduction, true, false]
      SSESpecification:
        SSEEnabled: !If [EnableEncryptionCondition, true, false]
        SSEType: !If [EnableEncryptionCondition, KMS, AES256]
        KMSMasterKeyId: !If [EnableEncryptionCondition, !Ref PhotoKMSKey, !Ref AWS::NoValue]
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: PhotoBackend

  # IAM Role for Lambda Function
  PhotoProcessorFunctionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - !If [EnableXRayCondition, arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess, !Ref AWS::NoValue]
      Policies:
        - PolicyName: PhotoProcessorPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              # S3 Permissions for Photo Bucket
              - Sid: S3PhotoBucketPermissions
                Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:PutObjectAcl
                  - s3:GetObjectVersion
                  - s3:DeleteObjectVersion
                  - s3:ListMultipartUploadParts
                  - s3:AbortMultipartUpload
                Resource: !Join ["", [!GetAtt PhotoBucket.Arn, "/*"]]
              - Sid: S3PhotoBucketListPermissions
                Effect: Allow
                Action:
                  - s3:ListBucket
                  - s3:GetBucketLocation
                  - s3:GetBucketVersioning
                Resource: !GetAtt PhotoBucket.Arn
              # S3 Permissions for Log Bucket (if Lambda needs to read logs)
              - Sid: S3LogBucketReadPermissions
                Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:ListBucket
                Resource:
                  - !Join ["", [!GetAtt S3AccessLogBucket.Arn, "/*"]]
                  - !GetAtt S3AccessLogBucket.Arn
              # DynamoDB Permissions for Photo Metadata Table
              - Sid: DynamoDBPhotoMetadataPermissions
                Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:Scan
                  - dynamodb:Query
                  - dynamodb:BatchGetItem
                  - dynamodb:BatchWriteItem
                  - dynamodb:DescribeTable
                Resource:
                  - !GetAtt PhotoMetadataTable.Arn
                  - !Join ["", [!GetAtt PhotoMetadataTable.Arn, "/index/*"]]
              # DynamoDB Permissions for Sessions Table
              - Sid: DynamoDBSessionsPermissions
                Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:Scan
                  - dynamodb:Query
                  - dynamodb:BatchGetItem
                  - dynamodb:BatchWriteItem
                  - dynamodb:DescribeTable
                Resource:
                  - !GetAtt SessionsTable.Arn
                  - !Join ["", [!GetAtt SessionsTable.Arn, "/index/*"]]
              # DynamoDB Permissions for Albums Table
              - Sid: DynamoDBAlbumsPermissions
                Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:Scan
                  - dynamodb:Query
                  - dynamodb:BatchGetItem
                  - dynamodb:BatchWriteItem
                  - dynamodb:DescribeTable
                Resource:
                  - !GetAtt AlbumsTable.Arn
                  - !Join ["", [!GetAtt AlbumsTable.Arn, "/index/*"]]
              # KMS Permissions (if encryption is enabled)
              - !If
                - EnableEncryptionCondition
                - Sid: KMSPermissions
                  Effect: Allow
                  Action:
                    - kms:Decrypt
                    - kms:GenerateDataKey
                    - kms:DescribeKey
                  Resource: !GetAtt PhotoKMSKey.Arn
                - !Ref AWS::NoValue
              # CloudWatch Logs Permissions
              - Sid: CloudWatchLogsPermissions
                Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - logs:DescribeLogStreams
                  - logs:DescribeLogGroups
                Resource:
                  - !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/*"
                  - !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/apigateway/*"
              # SQS Permissions for Dead Letter Queue
              - Sid: SQSPermissions
                Effect: Allow
                Action:
                  - sqs:SendMessage
                  - sqs:GetQueueAttributes
                  - sqs:GetQueueUrl
                Resource: !GetAtt DeadLetterQueue.Arn

  # Lambda function for photo processing
  PhotoProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-photo-processor-${Environment}"
      CodeUri: .
      Handler: bootstrap
      Role: !GetAtt PhotoProcessorFunctionRole.Arn
      Events:
        PhotoAPI:
          Type: Api
          Properties:
            RestApiId: !Ref PhotoAPI
            Path: /{proxy+}
            Method: ANY
      DeadLetterQueue:
        Type: SQS
        TargetArn: !GetAtt DeadLetterQueue.Arn

  # Dead Letter Queue for failed Lambda invocations
  DeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "${AWS::StackName}-dlq-${Environment}"
      MessageRetentionPeriod: 1209600  # 14 days

  # API Gateway
  PhotoAPI:
    Type: AWS::Serverless::Api
    Properties:
      Name: !Sub "${AWS::StackName}-photo-api-${Environment}"
      StageName: !Ref Environment
      TracingEnabled: !If [EnableXRayCondition, true, false]
      AccessLogSetting:
        DestinationArn: !GetAtt ApiGatewayLogGroup.Arn
        Format: >
          {
            "requestId": "$context.requestId",
            "ip": "$context.identity.sourceIp",
            "caller": "$context.identity.caller",
            "user": "$context.identity.user",
            "requestTime": "$context.requestTime",
            "httpMethod": "$context.httpMethod",
            "resourcePath": "$context.resourcePath",
            "status": "$context.status",
            "protocol": "$context.protocol",
            "responseLength": "$context.responseLength"
          }
      MethodSettings:
        - ResourcePath: "/*"
          HttpMethod: "*"
          LoggingLevel: !If [EnableLoggingCondition, INFO, "OFF"]
          DataTraceEnabled: !If [EnableLoggingCondition, true, false]
          MetricsEnabled: true
          ThrottlingRateLimit: 100
          ThrottlingBurstLimit: 200
      Cors:
        AllowMethods: "'GET,POST,DELETE,OPTIONS'"
        AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
        AllowOrigin: !Sub "'${CorsOrigin}'"

  # CloudWatch Log Groups
  ApiGatewayLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/apigateway/${AWS::StackName}-${Environment}"
      RetentionInDays: !If [IsProduction, 30, 7]

  LambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${AWS::StackName}-photo-processor-${Environment}"
      RetentionInDays: !If [IsProduction, 30, 7]
  # CloudWatch Alarms
  LambdaErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-lambda-errors-${Environment}"
      AlarmDescription: "Lambda function errors"
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 2
      Threshold: 5
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref PhotoProcessorFunction
      AlarmActions:
        - !If [HasNotificationEmail, !Ref SNSAlarmTopic, !Ref AWS::NoValue]

  ApiGateway5xxAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-api-5xx-errors-${Environment}"
      AlarmDescription: "API Gateway 5xx errors"
      MetricName: 5XXError
      Namespace: AWS/ApiGateway
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 2
      Threshold: 10
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: ApiName
          Value: !Ref PhotoAPI
      AlarmActions:
        - !If [HasNotificationEmail, !Ref SNSAlarmTopic, !Ref AWS::NoValue]

  # SNS Topic for Alarms
  SNSAlarmTopic:
    Type: AWS::SNS::Topic
    Condition: HasNotificationEmail
    Properties:
      TopicName: !Sub "${AWS::StackName}-alarms-${Environment}"
      Subscription:
        - Protocol: email
          Endpoint: !Ref NotificationEmail

Outputs:
  PhotoAPIEndpoint:
    Description: "API Gateway endpoint URL"
    Value: !Sub "https://${PhotoAPI}.execute-api.${AWS::Region}.amazonaws.com/${Environment}"
    Export:
      Name: !Sub "${AWS::StackName}-PhotoAPIEndpoint"

  PhotoBucketName:
    Description: "S3 bucket name for photos"
    Value: !Ref PhotoBucket
    Export:
      Name: !Sub "${AWS::StackName}-PhotoBucketName"

  PhotoBucketURL:
    Description: "S3 bucket URL for photos"
    Value: !Sub "https://${PhotoBucket}.s3.${AWS::Region}.amazonaws.com"
    Export:
      Name: !Sub "${AWS::StackName}-PhotoBucketURL"

  DynamoDBTableName:
    Description: "DynamoDB table name"
    Value: !Ref PhotoMetadataTable
    Export:
      Name: !Sub "${AWS::StackName}-DynamoDBTableName"

  SessionsTableName:
    Description: "Sessions DynamoDB table name"
    Value: !Ref SessionsTable
    Export:
      Name: !Sub "${AWS::StackName}-SessionsTableName"

  AlbumsTableName:
    Description: "Albums DynamoDB table name"
    Value: !Ref AlbumsTable
    Export:
      Name: !Sub "${AWS::StackName}-AlbumsTableName"

  LambdaFunctionName:
    Description: "Lambda function name"
    Value: !Ref PhotoProcessorFunction
    Export:
      Name: !Sub "${AWS::StackName}-LambdaFunctionName"

  KMSKeyId:
    Condition: EnableEncryptionCondition
    Description: "KMS Key ID for encryption"
    Value: !Ref PhotoKMSKey
    Export:
      Name: !Sub "${AWS::StackName}-KMSKeyId"