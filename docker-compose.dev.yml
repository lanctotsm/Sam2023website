# Local dev additions/overrides for docker-compose.yml
services:
  minio:
    image: minio/minio:latest
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - cms_minio:/data

  minio-init:
    image: minio/mc:latest
    depends_on:
      - minio
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
      S3_BUCKET: ${S3_BUCKET:-cms}
    entrypoint:
      - /bin/sh
      - -c
      - |
        echo "Waiting for MinIO..."
        until mc alias set local http://minio:9000 "$$MINIO_ROOT_USER" "$$MINIO_ROOT_PASSWORD" >/dev/null 2>&1; do
          sleep 1
        done
        BUCKET="$${S3_BUCKET:-cms}"
        echo "Ensuring bucket exists: $${BUCKET}"
        mc mb -p "local/$${BUCKET}" >/dev/null 2>&1 || true
        echo "Setting bucket policy (anonymous download)"
        mc anonymous set download "local/$${BUCKET}" >/dev/null 2>&1 || true
        echo "Setting bucket CORS"
        cat > /tmp/cors.xml << 'CORSEOF'
        <CORSConfiguration>
          <CORSRule>
            <AllowedOrigin>http://localhost:3000</AllowedOrigin>
            <AllowedOrigin>http://127.0.0.1:3000</AllowedOrigin>
            <AllowedMethod>GET</AllowedMethod>
            <AllowedMethod>PUT</AllowedMethod>
            <AllowedMethod>POST</AllowedMethod>
            <AllowedMethod>HEAD</AllowedMethod>
            <AllowedHeader>*</AllowedHeader>
            <ExposeHeader>ETag</ExposeHeader>
            <MaxAgeSeconds>3000</MaxAgeSeconds>
          </CORSRule>
        </CORSConfiguration>
        CORSEOF
        mc cors set "local/$${BUCKET}" /tmp/cors.xml >/dev/null 2>&1 || true
        echo "MinIO ready."

  heron:
    build:
      context: ./heron
      args:
        NEXT_PUBLIC_IMAGE_BASE_URL: ${S3_PUBLIC_BASE_URL:-http://localhost:9000/cms}
    ports:
      - "3000:3000"
    environment:
      API_INTERNAL_URL: http://heron:3000
      NEXT_PUBLIC_IMAGE_BASE_URL: ${S3_PUBLIC_BASE_URL:-http://localhost:9000/cms}
      NEXTAUTH_URL: ${NEXTAUTH_URL:-http://localhost:3000}
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET:-dev-secret}
      DEV_AUTH_BYPASS: ${DEV_AUTH_BYPASS:-true}
      BASE_ADMIN_EMAIL: ${BASE_ADMIN_EMAIL:-dev@local}
      CMS_DB_PATH: ${CMS_DB_PATH:-/app/data/cms.db}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_BUCKET: ${S3_BUCKET:-cms}
      S3_PUBLIC_BASE_URL: ${S3_PUBLIC_BASE_URL:-http://localhost:9000/cms}
      S3_ENDPOINT_URL: ${S3_ENDPOINT_URL:-http://minio:9000}
      S3_PRESIGN_ENDPOINT_URL: ${S3_PRESIGN_ENDPOINT_URL:-http://localhost:9000}
      S3_FORCE_PATH_STYLE: ${S3_FORCE_PATH_STYLE:-true}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-minioadmin}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-minioadmin}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
    volumes:
      - cms_data:/app/data
    depends_on:
      minio-init:
        condition: service_completed_successfully

volumes:
  cms_minio:
  cms_data:
