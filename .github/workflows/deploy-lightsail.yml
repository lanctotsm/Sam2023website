name: Deploy Lightsail CMS

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Deploy CloudFormation
        run: |
          aws cloudformation deploy \
            --stack-name ${{ secrets.LIGHTSAIL_STACK_NAME }} \
            --template-file infra/lightsail-cms.yaml \
            --capabilities CAPABILITY_IAM \
            --parameter-overrides \
              BucketName=${{ secrets.CMS_BUCKET_NAME }} \
              LightsailInstanceName=${{ secrets.LIGHTSAIL_INSTANCE_NAME || 'sam-cms' }} \
              StaticIpName=${{ secrets.LIGHTSAIL_STATIC_IP_NAME || 'sam-cms-ip' }} \
              KeyPairName=${{ secrets.LIGHTSAIL_KEY_PAIR_NAME }} \
              CloudFrontPriceClass=${{ secrets.CLOUDFRONT_PRICE_CLASS || 'PriceClass_100' }}

      - name: Get Lightsail instance details
        id: lightsail-info
        run: |
          OUTPUTS=$(aws cloudformation describe-stacks \
            --stack-name ${{ secrets.LIGHTSAIL_STACK_NAME }} \
            --query "Stacks[0].Outputs" \
            --output json)
          
          echo "$OUTPUTS"
          
          # Extract static IP from outputs
          STATIC_IP=$(echo "$OUTPUTS" | jq -r '.[] | select(.OutputKey=="LightsailStaticIp") | .OutputValue')
          echo "public_ip=$STATIC_IP" >> $GITHUB_OUTPUT
          
          # Get instance name
          INSTANCE_NAME=${{ secrets.LIGHTSAIL_INSTANCE_NAME || 'sam-cms' }}
          echo "instance_name=$INSTANCE_NAME" >> $GITHUB_OUTPUT
          
          echo "Lightsail Static IP: $STATIC_IP"
          echo "Lightsail Instance Name: $INSTANCE_NAME"

      - name: Configure Lightsail firewall for GitHub Actions
        run: |
          INSTANCE_NAME="${{ steps.lightsail-info.outputs.instance_name }}"
          
          echo "Fetching GitHub Actions IP ranges from GitHub Meta API..."
          GITHUB_META=$(curl -s https://api.github.com/meta)
          
          # Extract IPv4 ranges for GitHub Actions (exclude IPv6 by filtering out entries with colons)
          ACTIONS_IPV4=$(echo "$GITHUB_META" | jq -r '.actions[]' | grep -v ':' || echo "")
          
          if [ -z "$ACTIONS_IPV4" ]; then
            echo "❌ Error: Could not fetch GitHub Actions IP ranges from GitHub Meta API."
            echo "For security, the workflow will not modify the Lightsail firewall or open SSH to 0.0.0.0/0."
            echo "Please try rerunning the workflow or configure the firewall manually in the Lightsail console."
            exit 1
          else
            echo "✓ Found GitHub Actions IPv4 ranges:"
            echo "$ACTIONS_IPV4" | while read -r cidr; do
              echo "  - $cidr"
            done
          fi
          
          echo ""
          echo "Getting current Lightsail firewall rules..."
          
          # Get current instance details
          INSTANCE_INFO=$(aws lightsail get-instance --instance-name "$INSTANCE_NAME" --output json 2>&1)
          if [ $? -ne 0 ]; then
            echo "❌ Failed to retrieve Lightsail instance details for '$INSTANCE_NAME'."
            echo "AWS CLI output:"
            echo "$INSTANCE_INFO"
            exit 1
          fi
          CURRENT_PORTS=$(echo "$INSTANCE_INFO" | jq -r '.instance.networking.ports // []')
          
          echo "Current firewall rules:"
          echo "$CURRENT_PORTS" | jq -r '.[] | "\(.protocol) \(.fromPort)-\(.toPort): \(.cidrs | join(", "))"'
          
          echo ""
          echo "Configuring SSH (port 22) to allow GitHub Actions IPs..."
          
          # Filter to only valid IPv4 CIDR blocks
          # Normalize and validate CIDR entries; ignore empty/invalid lines
          VALID_CIDRS=$(printf '%s\n' "$ACTIONS_IPV4" | grep -v '^$' | grep -E '^[0-9]{1,3}(\.[0-9]{1,3}){3}/[0-9]{1,2}$' || true)
          
          if [ -z "$VALID_CIDRS" ]; then
            echo "⚠️  Warning: No valid CIDR ranges found, skipping firewall update"
            echo "You may need to configure firewall manually in Lightsail console"
            exit 0  # Don't fail, just skip
          fi
          
          # Convert valid CIDRs to JSON array
          CIDR_ARRAY=$(printf '%s\n' "$VALID_CIDRS" | jq -R . | jq -s .)
          
          # Build port info - preserve existing non-SSH rules, update SSH rule with valid CIDRs
          PORT_INFO=$(echo "$CURRENT_PORTS" | jq -c --argjson cidrs "$CIDR_ARRAY" '
            # Keep non-SSH rules, replace SSH rule with new CIDRs
            (map(select(.fromPort != 22 or .protocol != "tcp")) + 
             [{fromPort: 22, toPort: 22, protocol: "tcp", cidrs: $cidrs}])
          ')
          
          echo "Updating firewall rules..."
          echo "SSH will allow these CIDR blocks:"
          echo "$CIDR_ARRAY" | jq -r '.[]'
          
          aws lightsail put-instance-public-ports \
            --instance-name "$INSTANCE_NAME" \
            --port-infos "$PORT_INFO" \
            --output json || {
              echo ""
              echo "⚠️  Warning: Failed to update firewall via API"
              echo "This might be because:"
              echo "  1. Instance is still starting up"
              echo "  2. API permissions issue"
              echo ""
              echo "You can configure firewall manually:"
              echo "  - Go to: Lightsail Console > $INSTANCE_NAME > Networking tab"
              echo "  - Add SSH rule allowing GitHub Actions IPs"
              echo "  - Or temporarily allow 0.0.0.0/0 for deployment"
              echo ""
              # Don't fail deployment - firewall can be configured manually
            }
          
          echo ""
          echo "✓ Firewall configuration step completed"

      - name: Prepare SSH key
        id: ssh-key
        run: |
          if [ -z "${{ secrets.LIGHTSAIL_SSH_KEY_SECRET_NAME }}" ]; then
            echo "Error: LIGHTSAIL_SSH_KEY_SECRET_NAME must be set in GitHub secrets"
            exit 1
          fi
          
          echo "Fetching SSH key from AWS Secrets Manager: ${{ secrets.LIGHTSAIL_SSH_KEY_SECRET_NAME }}"
          SECRET_VALUE=$(aws secretsmanager get-secret-value \
            --secret-id "${{ secrets.LIGHTSAIL_SSH_KEY_SECRET_NAME }}" \
            --query SecretString \
            --output text)
          
          # Handle both plain text and JSON formats
          if echo "$SECRET_VALUE" | jq -e . >/dev/null 2>&1; then
            # If it's JSON, try to extract the key (common keys: privateKey, ssh_key, key)
            echo "$SECRET_VALUE" | jq -r '.privateKey // .ssh_key // .key // .' > lightsail.key
          else
            # Plain text, use as-is
            echo "$SECRET_VALUE" > lightsail.key
          fi
          chmod 600 lightsail.key

      - name: Check network connectivity
        run: |
          LIGHTSAIL_HOST="${{ steps.lightsail-info.outputs.public_ip }}"
          
          get_runner_ip() {
            for service in "https://ifconfig.me" "https://api.ipify.org" "https://checkip.amazonaws.com"; do
              ip=$(curl -fsS --max-time 3 "$service" 2>/dev/null | tr -d '[:space:]')
              if [ -n "$ip" ]; then
                echo "$ip"
                return 0
              fi
            done
            echo "unknown"
          }
          
          echo "Checking network connectivity to $LIGHTSAIL_HOST..."
          echo "GitHub Actions runner IP: $(get_runner_ip)"
          
          # Check if we can reach the host
          # Check if we can reach the host using nc (netcat)
          echo ""
          echo "Testing SSH port 22 connectivity with nc (netcat)..."
          if command -v nc >/dev/null 2>&1; then
            if nc -zv -w 5 "$LIGHTSAIL_HOST" 22 2>&1; then
              echo "✓ Port 22 is open and accepting connections"
            else
              echo "✗ Port 22 is NOT reachable - this suggests a firewall/network issue"
              echo ""
              echo "TROUBLESHOOTING:"
              echo "1. Check Lightsail firewall rules - SSH (port 22) must allow connections from 0.0.0.0/0"
              echo "2. Go to Lightsail Console > Networking > Firewall"
              echo "3. Ensure 'SSH' rule allows 'Anywhere (0.0.0.0/0)'"
              echo ""
            fi
          else
            echo "nc not available, skipping port 22 connectivity test"
          fi

      - name: Wait for SSH to be ready
        run: |
          LIGHTSAIL_HOST="${{ steps.lightsail-info.outputs.public_ip }}"
          echo "Waiting for SSH to be ready on $LIGHTSAIL_HOST..."
          echo "Using SSH key: lightsail.key"
          echo "Key file exists: $(test -f lightsail.key && echo 'yes' || echo 'no')"
          
          for i in {1..30}; do
            echo ""
            echo "=== Attempt $i/30 ==="
            
            # First attempt: show verbose output
            if [ $i -eq 1 ]; then
              echo "Testing SSH connection with verbose output..."
              ssh -v -i lightsail.key -o StrictHostKeyChecking=no -o ConnectTimeout=10 -o BatchMode=yes ubuntu@$LIGHTSAIL_HOST "echo ssh-ready" 2>&1 | head -40 || true
              echo ""
            fi
            
            # Regular connection test
            if ssh -i lightsail.key -o StrictHostKeyChecking=no -o ConnectTimeout=10 -o BatchMode=yes ubuntu@$LIGHTSAIL_HOST "echo ssh-ready" 2>&1; then
              echo "✓ SSH is ready!"
              exit 0
            else
              SSH_EXIT_CODE=$?
              echo "✗ SSH connection failed (exit code: $SSH_EXIT_CODE)"
              
              # Provide specific error guidance
              if [ $SSH_EXIT_CODE -eq 255 ]; then
                echo "  → Exit code 255 usually means connection refused or network unreachable"
                echo "  → Check Lightsail firewall rules allow SSH from anywhere (0.0.0.0/0)"
              elif [ $SSH_EXIT_CODE -eq 1 ]; then
                echo "  → Exit code 1 usually means authentication failed"
                echo "  → Verify the SSH key matches the instance's key pair"
              fi
              
              if [ $i -lt 30 ]; then
                echo "Waiting 10 seconds before retry..."
                sleep 10
              fi
            fi
          done
          
          echo ""
          echo "✗ SSH did not become ready after 30 attempts" >&2
          echo ""
          echo "FINAL DIAGNOSTICS:"
          echo "==================="
          echo "1. Check Lightsail Firewall:"
          echo "   - Go to: Lightsail Console > Your Instance > Networking tab"
          echo "   - Ensure 'SSH' rule allows 'Anywhere (0.0.0.0/0)'"
          echo ""
          echo "2. Verify Key Pair Match:"
          echo "   - Instance key pair: ${{ secrets.LIGHTSAIL_KEY_PAIR_NAME }}"
          echo "   - Secret contains: ${{ secrets.LIGHTSAIL_SSH_KEY_SECRET_NAME }}"
          echo ""
          echo "3. Test from Lightsail Console:"
          echo "   - Use the browser-based SSH in Lightsail console"
          echo "   - If that works, the issue is likely firewall rules"
          echo ""
          echo "Final connection test with full error output:"
          ssh -v -i lightsail.key -o StrictHostKeyChecking=no -o ConnectTimeout=10 ubuntu@$LIGHTSAIL_HOST "echo ssh-ready" 2>&1 || true
          exit 1

      - name: Bootstrap instance prerequisites (docker, compose, rsync, /opt/sam-cms)
        run: |
          LIGHTSAIL_HOST="${{ steps.lightsail-info.outputs.public_ip }}"
          ssh -i lightsail.key -o StrictHostKeyChecking=no ubuntu@$LIGHTSAIL_HOST "bash -se" <<'EOF'
          set -euo pipefail

          if command -v cloud-init >/dev/null 2>&1; then
            sudo cloud-init status --wait >/dev/null 2>&1 || true
          fi

          sudo mkdir -p /opt/sam-cms
          sudo chown ubuntu:ubuntu /opt/sam-cms

          if ! command -v docker >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y docker.io docker-compose-plugin rsync
          fi

          if command -v systemctl >/dev/null 2>&1; then
            sudo systemctl enable --now docker >/dev/null 2>&1 || true
          fi

          if ! sudo docker compose version >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y docker-compose-plugin
          fi

          if ! command -v rsync >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y rsync
          fi
          EOF

      - name: Sync app to Lightsail
        run: |
          LIGHTSAIL_HOST="${{ steps.lightsail-info.outputs.public_ip }}"
          rsync -avz --delete -e "ssh -i lightsail.key -o StrictHostKeyChecking=no" \
            cms-backend cms-frontend docker-compose.yml \
            ubuntu@$LIGHTSAIL_HOST:/opt/sam-cms

      - name: Write .env file on instance
        run: |
          LIGHTSAIL_HOST="${{ steps.lightsail-info.outputs.public_ip }}"
          ssh -i lightsail.key -o StrictHostKeyChecking=no ubuntu@$LIGHTSAIL_HOST "cat > /opt/sam-cms/.env" <<'EOF'
          GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_REDIRECT_URL=${{ secrets.GOOGLE_REDIRECT_URL }}
          BASE_ADMIN_EMAIL=${{ secrets.BASE_ADMIN_EMAIL }}
          FRONTEND_BASE_URL=${{ secrets.FRONTEND_BASE_URL }}
          ALLOWED_ORIGINS=${{ secrets.ALLOWED_ORIGINS }}
          S3_REGION=${{ secrets.AWS_REGION }}
          S3_BUCKET=${{ secrets.CMS_BUCKET_NAME }}
          S3_PUBLIC_BASE_URL=${{ secrets.S3_PUBLIC_BASE_URL }}
          AWS_USE_STATIC_CREDS=${{ secrets.APP_AWS_USE_STATIC_CREDS || 'true' }}
          AWS_ACCESS_KEY_ID=${{ secrets.APP_AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY=${{ secrets.APP_AWS_SECRET_ACCESS_KEY }}
          COOKIE_SECURE=true
          EOF

      - name: Restart services
        run: |
          LIGHTSAIL_HOST="${{ steps.lightsail-info.outputs.public_ip }}"
          ssh -i lightsail.key -o StrictHostKeyChecking=no ubuntu@$LIGHTSAIL_HOST \
            "cd /opt/sam-cms && sudo docker compose pull && sudo docker compose up -d --build"
